#!/usr/bin/env python3
# _*_ coding:utf-8 _*_
# CVE-2020-2551
# updated 2019/10/23
#

import pathlib
import re
import socket
import sys
import time
from typing import Any, Tuple

try:
    from utils import PLUGIN_TYPE, plugin, urlutil
except:
    sys.path.append(pathlib.Path(__file__).parent.parent.__str__())
    from utils import PLUGIN_TYPE, plugin, urlutil


class Plugin(plugin.PluginBase):
    def set_info(self):
        return {
            'name': 'Oracle WebLogic Server WLS Core Components Remote Code Execution',
            'catalog': 'CVE-2020-2551',
            'itype': PLUGIN_TYPE.MODULE,
            'protocols': ['t3'],
            'port': '7001',
        }

    def run(self, url: urlutil.Url, timeout=5, *args, **kwargs) -> Tuple[bool, Any]:
        # 对端响应数据需要一段时间，使用 delay 来控制，如果不成功，可以加到 3s 左右，超过这个基本都是打了补丁的
        try:
            self.tcp.connect()
        except socket.timeout:
            return False, 'connection timeout.'
        except ConnectionRefusedError:
            return False, 'connection refuse.'

        err, b_response = self.tcp.rq(
            b'GIOP\x01\x02\x00\x03\x00\x00\x00\x17\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x0bNameService'
        )
        if err:
            return False, err
        r_response = re.search(rb'[^\x00-\x20]*GIOP[^\x00-\x20]*', b_response)
        ret = r_response.group(0) if r_response else 'finish.'
        return b'GIOP' in b_response, ret


if __name__ == '__main__':
    import time

    from utils import net_echo

    nc = net_echo.DnslogCn()
    nc.start_service()
    plugin = Plugin(nc)

    s_time = time.time()
    ret = plugin.do_testing('192.168.245.128')
    print(ret)
    print(ret['is_exists'])
    print('total time(s):', time.time() - s_time)
